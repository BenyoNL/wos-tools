<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Tundra Album Csere</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 20px; background-color: #f4f7f6; }
        .container { background: white; max-width: 600px; margin: auto; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        /* Gombok √©s ≈±rlapok (a kor√°bbiak) */
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
        .btn { padding: 10px 20px; margin: 5px 0; font-size: 16px; cursor: pointer; color: white; border: none; border-radius: 5px; font-weight: bold; width: 90%; }
        .btn-blue { background-color: #4285F4; } .btn-blue:hover { background-color: #357ae8; }
        .btn-green { background-color: #28a745; } .btn-green:hover { background-color: #218838; }
        .btn-dark { background-color: #333; } .btn-dark:hover { background-color: #555; }
        .btn-red { background-color: #d9534f; } .btn-red:hover { background-color: #c9302c; }
        
        /* √öJ: A j√°t√©khoz hasonl√≥ R√°cs Design */
        .album-title { background: #e09f3e; color: white; padding: 10px; border-radius: 8px; margin-top: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .puzzle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        
        .puzzle-piece { 
            background: #5a82e6; /* A j√°t√©k k√©kje */
            border-radius: 8px; 
            padding: 5px; 
            position: relative;
            box-shadow: inset 0 0 10px rgba(255,255,255,0.3), 0 2px 4px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            min-height: 120px;
        }
        
        .stars { color: #ffd700; font-size: 14px; text-shadow: 1px 1px 1px #000; margin-bottom: 5px;}
        .piece-shape { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px;}
        
        /* Mennyis√©g szab√°lyz√≥ gombok */
        .controls { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 5px; background: white; border-radius: 5px; overflow: hidden; }
        .qty-btn { background: #ddd; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .qty-btn.plus { background: #6bc85f; color: white; }
        .qty-btn.minus { background: #d9534f; color: white; }
        .qty-display { font-weight: bold; color: #333; }
        
        /* St√°tusz sz√≠nek (Ha 0, sz√ºrke) */
        .piece-missing .puzzle-piece { background: #8892a3; }
        .piece-missing .piece-shape { background: rgba(0,0,0,0.2); color: #555; }

        #save-status { color: green; font-weight: bold; height: 20px; margin: 10px 0; }
    </style>
</head>
<body>

    <div id="auth-screen" class="container">
        <h2>L√©pj be vagy Regisztr√°lj</h2>
        <input type="email" id="email-input" placeholder="E-mail c√≠m">
        <input type="password" id="password-input" placeholder="Jelsz√≥">
        <div id="auth-error" style="color:red"></div>
        <button id="email-login-btn" class="btn btn-green">Bel√©p√©s E-maillel</button>
        <button id="email-register-btn" class="btn btn-dark">√öj fi√≥k regisztr√°l√°sa</button>
        <hr><button id="google-login-btn" class="btn btn-blue">Bel√©p√©s Google fi√≥kkal</button>
    </div>

    <div id="profile-setup-screen" class="container" style="display: none;">
        <h2>Hozd l√©tre a profilod</h2>
        <input type="text" id="player-name" placeholder="J√°t√©kosneved">
        <input type="number" id="server-number" placeholder="Szerver sz√°ma">
        <input type="text" id="alliance-name" placeholder="Sz√∂vets√©g r√∂vid√≠t√©se">
        <div id="profile-error" style="color:red"></div>
        <button id="save-profile-btn" class="btn btn-green">Ment√©s √©s Tov√°bb</button>
    </div>

    <div id="main-app-screen" class="container" style="display: none;">
        <h2><span id="display-name" style="color:#4285F4;"></span></h2>
        <p>Szerver: <b id="display-server"></b> | Kl√°n: <b id="display-alliance"></b></p>
        
        <div id="save-status"></div>
        
        <h3 class="album-title">üå≥ Distant Resonance</h3>
        <div id="distant-resonance-grid" class="puzzle-grid"></div>

        <br><hr><br>
        <button id="save-inventory-btn" class="btn btn-green" style="font-size: 18px; padding: 15px;">üíæ V√°ltoz√°sok Ment√©se</button>
        <br>
        <button id="logout-btn" class="btn btn-red" style="width: auto; margin-top: 20px;">Kijelentkez√©s</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // IDE M√ÅSOLD BE A SAJ√ÅT KULCSODAT!
        const firebaseConfig = {
  apiKey: "AIzaSyDeEK5nOuvuELtGd61Q7W04uKGcJqG1L1U",
  authDomain: "tundra-album.firebaseapp.com",
  projectId: "tundra-album",
  storageBucket: "tundra-album.firebasestorage.app",
  messagingSenderId: "469371801375",
  appId: "1:469371801375:web:71007b232a98fe8bdbea2a",
  measurementId: "G-2LQT9X23X5"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUserUid = null;
        let userInventory = {}; // Ebben t√°roljuk az aktu√°lis k√°rty√°kat a mem√≥ri√°ban

        // K√©perny≈ëk
        const authScreen = document.getElementById('auth-screen');
        const profileScreen = document.getElementById('profile-setup-screen');
        const mainScreen = document.getElementById('main-app-screen');

        function showScreen(screen) {
            authScreen.style.display = 'none'; profileScreen.style.display = 'none'; mainScreen.style.display = 'none';
            screen.style.display = 'block';
        }

        // --- Alap Bel√©p√©si Logik√°k ---
        document.getElementById('email-register-btn').addEventListener('click', () => createUserWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = e.message));
        document.getElementById('email-login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value).catch(e => document.getElementById('auth-error').textContent = "Hib√°s adat."));
        document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider).catch(e => console.error(e)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const pName = document.getElementById('player-name').value;
            const pServer = document.getElementById('server-number').value;
            const pAlliance = document.getElementById('alliance-name').value;
            if(!pName || !pServer || !pAlliance) return document.getElementById('profile-error').textContent = "T√∂lts ki mindent!";
            await setDoc(doc(db, "jatekosok", currentUserUid), { jatekNev: pName, szerver: pServer, szovetseg: pAlliance, inventory: {} });
            checkUserProfile(currentUserUid);
        });

        async function checkUserProfile(uid) {
            const docSnap = await getDoc(doc(db, "jatekosok", uid));
            if (docSnap.exists() && docSnap.data().szerver) {
                const data = docSnap.data();
                document.getElementById('display-name').textContent = data.jatekNev || data.nev;
                document.getElementById('display-server').textContent = data.szerver;
                document.getElementById('display-alliance').textContent = data.szovetseg;
                
                // Let√∂ltj√ºk a j√°t√©kos eddigi k√°rty√°it
                userInventory = data.inventory || {}; 
                
                renderPuzzleGrid(); // Kirajzoljuk a r√°csot
                showScreen(mainScreen);
            } else {
                showScreen(profileScreen);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) { currentUserUid = user.uid; checkUserProfile(user.uid); } 
            else { currentUserUid = null; showScreen(authScreen); }
        });

        // --- √öJ: PUZZLE R√ÅCS GENER√ÅL√ÅSA √âS KEZEL√âSE ---
        
        function renderPuzzleGrid() {
            const gridContainer = document.getElementById('distant-resonance-grid');
            gridContainer.innerHTML = ''; // Ki√ºr√≠tj√ºk, ha volt benne valami
            
            // L√©trehozunk 15 darab k√°rty√°t
            for(let i = 1; i <= 15; i++) {
                const pieceId = `distant_resonance_${i}`;
                // Megn√©zz√ºk, van-e m√°r elmentett darab bel≈ële, ha nincs, akkor 0.
                const currentQty = userInventory[pieceId] || 0; 
                
                // Div l√©trehoz√°sa HTML-ben
                const pieceDiv = document.createElement('div');
                pieceDiv.className = currentQty === 0 ? 'piece-missing' : ''; // Ha 0, kisz√ºrk√≠tj√ºk
                
                // A csillagokat kb. elosztjuk, ahogy a k√©pen l√°tszik (1-5-ig n√∂vekszik a sorok szerint)
                const starCount = Math.ceil(i / 3); 
                const starsHtml = '‚≠ê'.repeat(starCount);

                pieceDiv.innerHTML = `
                    <div class="puzzle-piece">
                        <div class="stars">${starsHtml}</div>
                        <div class="piece-shape">${i}.</div>
                        <div class="controls">
                            <button class="qty-btn minus" onclick="updateQty('${pieceId}', -1)">-</button>
                            <span class="qty-display" id="qty-${pieceId}">${currentQty}</span>
                            <button class="qty-btn plus" onclick="updateQty('${pieceId}', 1)">+</button>
                        </div>
                    </div>
                `;
                gridContainer.appendChild(pieceDiv);
            }
        }

        // Glob√°lis f√ºggv√©ny, amit a plusz/m√≠nusz gombok h√≠vnak meg
        window.updateQty = function(pieceId, change) {
            let currentQty = userInventory[pieceId] || 0;
            currentQty += change;
            if (currentQty < 0) currentQty = 0; // Ne lehessen m√≠nuszba menni!
            
            userInventory[pieceId] = currentQty; // Friss√≠tj√ºk a mem√≥ri√°ban
            
            // Friss√≠tj√ºk a k√©perny≈ën a sz√°mot
            document.getElementById(`qty-${pieceId}`).textContent = currentQty;
            
            // Kisz√ºrk√≠tj√ºk/Kisz√≠nezz√ºk a dobozt a sz√°m alapj√°n
            const pieceBox = document.getElementById(`qty-${pieceId}`).closest('.piece-missing, div');
            if(currentQty === 0) {
                pieceBox.parentElement.classList.add('piece-missing');
            } else {
                pieceBox.parentElement.classList.remove('piece-missing');
            }
        };

        // Ment√©s az Adatb√°zisba gomb
        document.getElementById('save-inventory-btn').addEventListener('click', async () => {
            const statusText = document.getElementById('save-status');
            statusText.textContent = "Ment√©s folyamatban...";
            statusText.style.color = "orange";

            try {
                // Csak az inventory r√©szt friss√≠tj√ºk az adatb√°zisban
                await updateDoc(doc(db, "jatekosok", currentUserUid), {
                    inventory: userInventory
                });
                statusText.textContent = "‚úî K√°rty√°k sikeresen elmentve!";
                statusText.style.color = "green";
                setTimeout(() => statusText.textContent = "", 3000);
            } catch (error) {
                console.error("Hiba:", error);
                statusText.textContent = "‚ùå Hiba t√∂rt√©nt a ment√©s sor√°n!";
                statusText.style.color = "red";
            }
        });
    </script>
</body>
</html>